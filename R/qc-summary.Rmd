---
title: "DataSHIELD QC Report"
output: html_document
date: "2024-05-09"
editor_options: 
  chunk_output_type: console
params:
  qc_stats: NULL
---

```{r setup, message = F, warning = F, echo = F, include = F}
knitr::opts_chunk$set(echo = FALSE)
options(datashield.progress = T)
```

### Technical: Is the cohort server currently up?
```{r server}
params$qc_stats$accessible %>% 
  pivot_longer(
    cols = c(success, message),
    names_to = "type",
    values_to = "value") %>%
  pivot_wider(
    names_from = cohort,
    values_from = value) %>%
  kbl(col.names = c("", params$qc_stats$accessible$cohort)) %>%
  kable_styling(bootstrap_options = c("striped", "hover")) %>%
  column_spec(1, "5cm")
```

### Technical: Which DataSHIELD packages are available?
```{r packages}
params$qc_stats$packages$version_status %>%
  as_tibble(rownames = "Package") %>%
  kbl() %>%
  kable_styling(bootstrap_options = c("striped", "hover"))
```

### High-level: Which tables are available for which cohorts?
```{r tables}
dic_info <- format_dictionary_info(params$qc_stats$coh_dics, params$qc_stats$all_dics)
cohort_names <- colnames(dic_info)[colnames(dic_info) != "dictionary"]

dic_info %>% 
  kbl(col.names = c("", cohort_names)) %>%
  kable_styling(bootstrap_options = c("striped", "hover")) %>%
  column_spec(1, "5cm")
```

### High-level: How many variables and observations do each cohort have available?
```{r variable-high-level}
variable_summary <- sumarise_total_vars_and_obs(params$qc_stats$variables)

variable_summary %>%
  kbl() %>%
  kable_styling(bootstrap_options = c("striped", "hover")) %>%
  column_spec(1, "5cm")
```

### High-level: How many observations per variable?
```{r observations-high-level}
obs_per_var <- summarise_obs_per_variable(params$qc_stats$variables)
groups <- .make_collapse_vector(obs_per_var)

obs_per_var %>%
  dplyr::select(-dictionary) %>%
  kbl() %>%
  kable_styling(bootstrap_options = c("striped", "hover")) %>%
  pack_rows(index = groups)
```

### Deatiled: What are the core demographics of each cohort?
```{r demographics-detailed}
demographics <- summarise_demographics(params$qc_stats$variables, params$qc_stats$demographics)

demographics %>%
  kbl() %>%
  kable_styling(bootstrap_options = c("striped", "hover"))
```


### Detailed: What are the class and values of all variables?
```{r variables-detailed}
detailed <- summarise_values_and_class(params$qc_stats$variables)
groups <- .make_collapse_vector(detailed)

detailed %>%
  dplyr::select(-dictionary) %>%
  kbl() %>%
  kable_styling(bootstrap_options = c("striped", "hover")) %>%
  pack_rows(index = groups)
```

